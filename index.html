<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Window Estimator AI</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        .marker { position: absolute; width: 24px; height: 24px; background: #ef4444; border: 2px solid white; border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .input-number::-webkit-outer-spin-button, .input-number::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-48">

    <header class="bg-slate-900 text-white p-5 shadow-md flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold">Window Estimator <span class="text-blue-400">AI</span></h1>
        <button onclick="resetData()" class="text-xs bg-slate-700 px-3 py-1 rounded">Reset All</button>
    </header>

    <main class="p-4 max-w-md mx-auto space-y-6">

        <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-slate-800 mb-3">üì∏ Visual Counter</h2>
            
            <div id="canvasContainer" class="relative w-full aspect-video bg-slate-100 rounded-xl overflow-hidden mb-3 border-2 border-dashed border-slate-300 flex items-center justify-center">
                <img id="mainPhoto" class="w-full h-full object-cover hidden" onclick="placeMarker(event)">
                <p id="placeholderText" class="text-slate-400 text-sm text-center px-4">Take a photo or upload one to start tapping windows</p>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setSelectedSize('small')" id="btn-small" class="size-btn py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-xs">Small</button>
                <button onclick="setSelectedSize('medium')" id="btn-medium" class="size-btn py-2 rounded-lg border-2 border-transparent bg-slate-100 text-slate-600 font-bold text-xs">Medium</button>
                <button onclick="setSelectedSize('large')" id="btn-large" class="size-btn py-2 rounded-lg border-2 border-transparent bg-slate-100 text-slate-600 font-bold text-xs">Large</button>
            </div>

            <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden">
            <input type="file" accept="image/*" id="uploadInput" class="hidden">
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="document.getElementById('cameraInput').click()" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-md">üì∏ Camera</button>
                <button onclick="document.getElementById('uploadInput').click()" class="bg-slate-800 text-white py-3 rounded-xl font-bold text-sm shadow-md">üìÅ Upload</button>
            </div>
        </section>

        <section class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-slate-800">Review Counts</h2>
                <label class="flex items-center gap-2 text-sm font-medium text-slate-600">
                    <input type="checkbox" id="taxToggle" onchange="calculate()" class="w-4 h-4 rounded text-blue-600"> Add Sales Tax (8.25%)
                </label>
            </div>
            <div id="countGrid" class="space-y-4"></div>
        </section>

    </main>

    <section class="fixed bottom-4 left-4 right-4 max-w-md mx-auto bg-slate-900 text-white p-5 rounded-2xl shadow-2xl z-50">
        <div class="flex justify-between items-center mb-4">
            <div>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Estimated Total</p>
                <p class="text-3xl font-black text-blue-400" id="totalPrice">$0.00</p>
            </div>
            <div class="text-right">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Windows</p>
                <p class="text-xl font-bold" id="totalCount">0</p>
            </div>
        </div>
        <button onclick="downloadSummary()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold active:scale-95 transition-transform">üíæ Download Estimate</button>
    </section>

    <script>
        const BASE_RATES = { small: 5, medium: 10, large: 15 };
        const TAX_RATE = 0.0825;
        let selectedSize = 'small';
        
        let counts = JSON.parse(localStorage.getItem('windowCounts')) || {
            small: { ground: 0, second: 0, third: 0 },
            medium: { ground: 0, second: 0, third: 0 },
            large: { ground: 0, second: 0, third: 0 }
        };

        function setSelectedSize(size) {
            selectedSize = size;
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.replace('border-blue-500', 'border-transparent');
                btn.classList.replace('bg-blue-50', 'bg-slate-100');
                btn.classList.replace('text-blue-700', 'text-slate-600');
            });
            const active = document.getElementById(`btn-${size}`);
            active.classList.replace('border-transparent', 'border-blue-500');
            active.classList.replace('bg-slate-100', 'bg-blue-50');
            active.classList.replace('text-slate-600', 'text-blue-700');
        }

        function initGrid() {
            const grid = document.getElementById('countGrid');
            grid.innerHTML = '<div class="grid grid-cols-4 gap-2 mb-1 text-[10px] font-bold text-slate-400 uppercase text-center"><div>Size</div><div>Gnd</div><div>2nd</div><div>3rd</div></div>';
            ['small', 'medium', 'large'].forEach(size => {
                const row = document.createElement('div');
                row.className = "grid grid-cols-4 gap-2 items-center";
                row.innerHTML = `<div class="capitalize font-bold text-slate-700 text-xs">${size}</div>` + 
                    ['ground', 'second', 'third'].map(h => `
                        <input type="number" value="${counts[size][h]}" oninput="updateCount('${size}', '${h}', this.value)" id="input-${size}-${h}"
                        class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-center font-bold text-sm focus:ring-2 focus:ring-blue-500">
                    `).join('');
                grid.appendChild(row);
            });
            calculate();
        }

        function updateCount(size, h, val) {
            counts[size][h] = parseInt(val) || 0;
            localStorage.setItem('windowCounts', JSON.stringify(counts));
            calculate();
        }

        function calculate() {
            let subtotal = 0, qty = 0;
            const multi = { ground: 1.0, second: 1.3, third: 1.6 };
            for(let s in counts) for(let h in counts[s]) {
                subtotal += counts[s][h] * (BASE_RATES[s] * multi[h]);
                qty += counts[s][h];
            }
            if(document.getElementById('taxToggle').checked) subtotal *= (1 + TAX_RATE);
            document.getElementById('totalPrice').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('totalCount').innerText = qty;
        }

        function placeMarker(e) {
            const rect = e.target.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.left = `${x}%`;
            marker.style.top = `${y}%`;
            document.getElementById('canvasContainer').appendChild(marker);

            counts[selectedSize].ground++;
            document.getElementById(`input-${selectedSize}-ground`).value = counts[selectedSize].ground;
            updateCount(selectedSize, 'ground', counts[selectedSize].ground);
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('mainPhoto');
                    img.src = ev.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('placeholderText').classList.add('hidden');
                    document.querySelectorAll('.marker').forEach(m => m.remove());
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('cameraInput').addEventListener('change', handleFile);
        document.getElementById('uploadInput').addEventListener('change', handleFile);

        function downloadSummary() {
            const total = document.getElementById('totalPrice').innerText;
            const qty = document.getElementById('totalCount').innerText;
            const taxStr = document.getElementById('taxToggle').checked ? " (Includes 8.25% Tax)" : "";
            const text = `WINDOW ESTIMATE\nTotal Windows: ${qty}\nFinal Total: ${total}${taxStr}`;
            const blob = new Blob([text], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Estimate_${Date.now()}.txt`;
            a.click();
        }

        function resetData() { if(confirm("Clear everything?")) { localStorage.clear(); location.reload(); } }

        initGrid();
    </script>
</body>
</html>
